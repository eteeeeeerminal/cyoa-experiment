<html>
<body>
  <div id="view"></div>
  <script id="main" type="cyoa-script"><!-
# ここからシナリオスクリプト
aaa
bbb
ccc
:next,95882c9d-ac51-46c3-b35c-97081d1246ae

*95882c9d-ac51-46c3-b35c-97081d1246ae,hoge
hoge

*fuga
fuga

# ここまでシナリオスクリプト
-></script>
  <script type="text/javascript">
let view = document.getElementById("view")
let source = document.getElementById("main").innerText.split(/[\r\n]/).slice(1).slice(0,-1)
let pos = 0;
let labelMap = {}
console.log(source)

const generateUuid=($=(a,b)=>(Math.floor(Math.random()*a)+b).toString(16))=>'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/x/g,_=>$(16,0)).replace(/y/g,_=>$(4,8));

function extractLabelId(line){
  return line.slice(1).split(/,/)[0]
}

function makeLabelMap(){
  source.forEach((line,index) => {
    if(line.length > 0 && line[0] == '*'){
      labelMap[extractLabelId(line)] = index
    }
  })
}

makeLabelMap()

function jump(label){
  pos = labelMap[label] + 1
}

function clear(){
  view.innerHTML = ""
}

function addText(s){
  let e = document.createElement("div")
  let t = document.createTextNode(s)
  e.appendChild(t)
  view.appendChild(e)
}

function addChoice(s, label){
  let e = document.createElement("button")
  let t = document.createTextNode(s)
  e.appendChild(t)
  view.appendChild(e)
  e.addEventListener("click", ()=>{
    jump(label)
    clear()
    run()
  })
}

function run(){
  let end = false
  let hasChoice = false
  while(!end && pos < source.length){
    let line = source[pos]
    if(line.length > 0){
      let type = ""
      switch(line[0]){
        case '#': //comment
        break
        case '*': //label
          if(!hasChoice){
            addChoice("次へ", line.slice(1))
          }
          end = true
        break
        case '%': //command
        break
        case ':': //choice
          let parts = line.slice(1).split(/,/)
          addChoice(parts[0], parts[1])
          hasChoice = true
        break
        default:
          addText(line)
      }
    }
    pos ++
  }

}

run()
  </script>
</body>
</html>
